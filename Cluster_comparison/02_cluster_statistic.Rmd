---
title: "cluster_statistics"
author: "Maria T. Secara"
date: "2025-09-10"
output: html_document
---

```{r}
#Load in the required libraries 
#install.packages("heplots")
#install.packages("effectsize")   
library(heplots)
library(ggsignif)
library(dplyr)
library(ggplot2)
library(broom)
library(tibble)
library(effectsize)

```

Loading in Data
```{r}
#Cluster statistics. Comparing features between clusters k=48, alpha=0.6
compare_df2 <- read.csv(".../SNF_output1/full_RESULTS_5_clust_k48_0.6.csv")
compare_df2$groups <- as.factor(compare_df2$groups)

#Loading in IQ data
iq<- read.csv(".../IQ/combined_demo_IQ_final.csv")
colnames(iq)[1] <- "participant_id"
iq_df <- iq[, c("participant_id", "iq")]
compare_df2 <- inner_join(compare_df2, iq_df, by = "participant_id")

#Characterizing group membership across clusters and diagnosis 
table(compare_df2$groups, compare_df2$group)
```

Characterizing the cluster based on membership
```{r}
#### Creating piecharts 

clust1 <- compare_df2[which(compare_df2$groups=="1"),]
clust2 <- compare_df2[which(compare_df2$groups=="2"),]
clust3 <- compare_df2[which(compare_df2$groups=="3"),]
clust4 <- compare_df2[which(compare_df2$groups=="4"),]
clust5 <- compare_df2[which(compare_df2$groups=="5"),]
#clust6 <- compare_df2[which(compare_df2$groups=="6"),]

# Looking at breakdown of diagnosis 
freq = table(compare_df2$group)
lbls = paste(names(freq), "-", round((freq/335)*100, 1), "%", sep="")
pie(freq, main="All participants", labels = lbls, cex=1.5, col=c("black", "darkgray", "white"))

# Looking at breakdown of biological sex 
freq = table(compare_df2$sex)
lbls = paste(names(freq), "-", round((freq/335)*100, 1), "%", sep="")
pie(freq, main="All participants", labels = lbls, cex=1.5, col=c("black", "white"))

#Cluster 1 
freq = table(clust1$group)
lbls = paste(names(freq), "-", round((freq/71)*100, 1), "%", sep="")
pie(freq, main="Cluster 1", labels = lbls,cex=1.5, col=c("black",  "darkgrey", "white"), lwd= 3)

#Cluster 2
freq = table(clust2$group)
lbls = paste(names(freq), "-", round((freq/71)*100, 1), "%", sep="")
pie(freq, main="Cluster 2", labels = lbls, cex=1.5, col=c("black",  "darkgrey", "white"))

#Cluster 3
freq = table(clust3$group)
lbls = paste(names(freq), "-", round((freq/90)*100, 1), "%", sep="")
pie(freq, main="Cluster 3", labels = lbls,cex=1.5, col=c("black","darkgrey","white"))

#Cluster 4
freq = table(clust4$group)
lbls = paste(names(freq), "-", round((freq/59)*100, 1), "%", sep="")
pie(freq, main="Cluster 4", labels = lbls,cex=1.5, col=c("black", "darkgray", "white"))

#Cluster 5
freq = table(clust5$group)
lbls = paste(names(freq), "-", round((freq/44)*100, 1), "%", sep="")
pie(freq, main="Cluster 5", labels = lbls,cex=1.5, col=c("black", "darkgray", "white"))

#Cluster 6
#freq = table(clust5$group)
#lbls = paste(names(freq), "-", round((freq/24)*100, 1), "%", sep="")
#pie(freq, main="Cluster 6", labels = lbls,cex=1.5, col=c("black", "darkgray", "white"))
```

########### Assessing Statistical Differences Across Input Features used in SNF ################### 

1. Social Cognition 
2. Cortical Thickness 
3. Subcortical Volume
4. Cortical Surface Area 
5. EA Task Regional Activation 


1. Social cognition 
```{r}
# -------------------------
# 1. ANOVA + TukeyHSD
# -------------------------
model1 <- aov(tasit2_psar ~ groups, data = compare_df2)
summary(model1)
car::Anova(model1)
eta_squared(model1)

TukeyHSD(model1)

tukey_res <- TukeyHSD(model1, "groups")$groups %>%
  as.data.frame() %>%
  rownames_to_column("contrast")

# -------------------------
# 2. Prepare comparisons
# -------------------------
# Split contrasts (e.g., "2-1") into list c("2","1")
comparisons <- strsplit(tukey_res$contrast, "-")

# Keep only significant comparisons
tukey_sig <- tukey_res %>% filter(`p adj` < 0.05)
comparisons_sig <- strsplit(tukey_sig$contrast, "-")

# Significance symbols
signif_labels <- ifelse(tukey_sig$`p adj` < 0.001, "***",
                   ifelse(tukey_sig$`p adj` < 0.01, "**",
                   ifelse(tukey_sig$`p adj` < 0.05, "*", "ns")))

# -------------------------
# 3. Assign y-positions
# -------------------------
y_max <- max(compare_df2$tasit2_psar, na.rm = TRUE) #### CHANGE HERE 
y_positions <- seq(y_max * 1.05,
                   by = y_max * 0.035, #increasing this will lead to great spaces betweem the bars 
                   length.out = length(comparisons_sig))

# -------------------------
# 4. Plot
# -------------------------
p <- ggplot(compare_df2, aes(x = groups, y = tasit2_psar, fill = groups)) + #CHANGE HERE
  geom_boxplot(color = "black") +
  scale_fill_manual(values = c("lightgreen", "seagreen", "aquamarine2",  
                               "lightblue", "blue", "purple")) +
  labs(title = "Box Plot of TASIT2 Paradoxical Sarcasm Score by Cluster",
       x = "Cluster group",
       y = "TASIT2 Paradoxical Sarcasm Score") +
  theme_minimal()
p
# Add Tukey significance bars
p + geom_signif(comparisons = comparisons_sig,
                annotations = signif_labels,
                y_position = y_positions,
                tip_length = 0.01,
                vjust = 0.7) #increasing this value will make the stars closer to the bar 

###############################################################################################################################################

# -------------------------
# 1. ANOVA + TukeyHSD
# -------------------------
model1 <- aov(tasit3_sar ~ groups, data = compare_df2)
summary(model1)
car::Anova(model1)
eta_squared(model1)

TukeyHSD(model1)

tukey_res <- TukeyHSD(model1, "groups")$groups %>%
  as.data.frame() %>%
  rownames_to_column("contrast")

# -------------------------
# 2. Prepare comparisons
# -------------------------
# Split contrasts (e.g., "2-1") into list c("2","1")
comparisons <- strsplit(tukey_res$contrast, "-")

# Keep only significant comparisons
tukey_sig <- tukey_res %>% filter(`p adj` < 0.05)
comparisons_sig <- strsplit(tukey_sig$contrast, "-")

# Significance symbols
signif_labels <- ifelse(tukey_sig$`p adj` < 0.001, "***",
                   ifelse(tukey_sig$`p adj` < 0.01, "**",
                   ifelse(tukey_sig$`p adj` < 0.05, "*", "ns")))

# -------------------------
# 3. Assign y-positions
# -------------------------
y_max <- max(compare_df2$tasit3_sar, na.rm = TRUE) #### CHANGE HERE 
y_positions <- seq(y_max * 1.05,
                   by = y_max * 0.035, #increasing this will lead to great spaces betweem the bars 
                   length.out = length(comparisons_sig))

# -------------------------
# 4. Plot
# -------------------------
p <- ggplot(compare_df2, aes(x = groups, y = tasit3_sar, fill = groups)) + #CHANGE HERE
  geom_boxplot(color = "black") +
  scale_fill_manual(values = c("lightgreen", "seagreen", "aquamarine2",  
                               "lightblue", "blue", "purple")) +
  labs(title = "Box Plot of TASIT3 Sarcasm Score by Cluster",
       x = "Cluster group",
       y = "TASIT3 Sarcasm Score") +
  theme_minimal()
p
# Add Tukey significance bars
p + geom_signif(comparisons = comparisons_sig,
                annotations = signif_labels,
                y_position = y_positions,
                tip_length = 0.01,
                vjust = 0.7) #increasing this value will make the stars closer to the bar 

###############################################################################################################################################

# -------------------------
# 1. ANOVA + TukeyHSD
# -------------------------
model1 <- aov(rmet_total ~ groups, data = compare_df2)
summary(model1)
car::Anova(model1)
eta_squared(model1)

TukeyHSD(model1)

tukey_res <- TukeyHSD(model1, "groups")$groups %>%
  as.data.frame() %>%
  rownames_to_column("contrast")

# -------------------------
# 2. Prepare comparisons
# -------------------------
# Split contrasts (e.g., "2-1") into list c("2","1")
comparisons <- strsplit(tukey_res$contrast, "-")

# Keep only significant comparisons
tukey_sig <- tukey_res %>% filter(`p adj` < 0.05)
comparisons_sig <- strsplit(tukey_sig$contrast, "-")

# Significance symbols
signif_labels <- ifelse(tukey_sig$`p adj` < 0.001, "***",
                   ifelse(tukey_sig$`p adj` < 0.01, "**",
                   ifelse(tukey_sig$`p adj` < 0.05, "*", "ns")))

# -------------------------
# 3. Assign y-positions
# -------------------------
y_max <- max(compare_df2$rmet_total, na.rm = TRUE) #### CHANGE HERE 
y_positions <- seq(y_max * 1.05,
                   by = y_max * 0.035, #increasing this will lead to great spaces betweem the bars 
                   length.out = length(comparisons_sig))

# -------------------------
# 4. Plot
# -------------------------
p <- ggplot(compare_df2, aes(x = groups, y = rmet_total, fill = groups)) + #CHANGE HERE
  geom_boxplot(color = "black") +
  scale_fill_manual(values = c("lightgreen", "seagreen", "aquamarine2",  
                               "lightblue", "blue", "purple")) +
  labs(title = "Box Plot of RMET Total Score by Cluster",
       x = "Cluster group",
       y = "RMET Total Score") +
  theme_minimal()
p
# Add Tukey significance bars
p + geom_signif(comparisons = comparisons_sig,
                annotations = signif_labels,
                y_position = y_positions,
                tip_length = 0.01,
                vjust = 0.7) #increasing this value will make the stars closer to the bar 

###############################################################################################################################################

# -------------------------
# 1. ANOVA + TukeyHSD
# -------------------------
model1 <- aov(tasit3_lies ~ groups, data = compare_df2)
summary(model1)
car::Anova(model1)
eta_squared(model1)

TukeyHSD(model1)

tukey_res <- TukeyHSD(model1, "groups")$groups %>%
  as.data.frame() %>%
  rownames_to_column("contrast")

# -------------------------
# 2. Prepare comparisons
# -------------------------
# Split contrasts (e.g., "2-1") into list c("2","1")
comparisons <- strsplit(tukey_res$contrast, "-")

# Keep only significant comparisons
tukey_sig <- tukey_res %>% filter(`p adj` < 0.05)
comparisons_sig <- strsplit(tukey_sig$contrast, "-")

# Significance symbols
signif_labels <- ifelse(tukey_sig$`p adj` < 0.001, "***",
                   ifelse(tukey_sig$`p adj` < 0.01, "**",
                   ifelse(tukey_sig$`p adj` < 0.05, "*", "ns")))

# -------------------------
# 3. Assign y-positions
# -------------------------
y_max <- max(compare_df2$tasit3_lies, na.rm = TRUE) #### CHANGE HERE 
y_positions <- seq(y_max * 1.05,
                   by = y_max * 0.035, #increasing this will lead to great spaces betweem the bars 
                   length.out = length(comparisons_sig))

# -------------------------
# 4. Plot
# -------------------------
p <- ggplot(compare_df2, aes(x = groups, y = tasit3_lies, fill = groups)) + #CHANGE HERE
  geom_boxplot(color = "black") +
  scale_fill_manual(values = c("lightgreen", "seagreen", "aquamarine2",  
                               "lightblue", "blue", "purple")) +
  labs(title = "Box Plot of TASIT3 Lies Score by Cluster",
       x = "Cluster group",
       y = "TASIT3 Lies Score") +
  theme_minimal()
p
# Add Tukey significance bars
p + geom_signif(comparisons = comparisons_sig,
                annotations = signif_labels,
                y_position = y_positions,
                tip_length = 0.01,
                vjust = 0.7) #increasing this value will make the stars closer to the bar 

```

2. Cortical Thickness 
```{r}
# -------------------------
# 1. ANOVA + TukeyHSD
# -------------------------
model1 <- aov(L_rostralmiddlefrontal_thickavg ~ groups, data = compare_df2)
summary(model1)
car::Anova(model1)
eta_squared(model1)
TukeyHSD(model1)

tukey_res <- TukeyHSD(model1, "groups")$groups %>%
  as.data.frame() %>%
  rownames_to_column("contrast")

# -------------------------
# 2. Prepare comparisons
# -------------------------
# Split contrasts (e.g., "2-1") into list c("2","1")
comparisons <- strsplit(tukey_res$contrast, "-")

# Keep only significant comparisons
tukey_sig <- tukey_res %>% filter(`p adj` < 0.05)
comparisons_sig <- strsplit(tukey_sig$contrast, "-")

# Significance symbols
signif_labels <- ifelse(tukey_sig$`p adj` < 0.001, "***",
                   ifelse(tukey_sig$`p adj` < 0.01, "**",
                   ifelse(tukey_sig$`p adj` < 0.05, "*", "ns")))

# -------------------------
# 3. Assign y-positions
# -------------------------
y_max <- max(compare_df2$L_rostralmiddlefrontal_thickavg, na.rm = TRUE) #### CHANGE HERE 
y_positions <- seq(y_max * 1.05,
                   by = y_max * 0.02, #increasing this will lead to great spaces betweem the bars 
                   length.out = length(comparisons_sig))

# -------------------------
# 4. Plot
# -------------------------
p <- ggplot(compare_df2, aes(x = groups, y = L_rostralmiddlefrontal_thickavg, fill = groups)) + #CHANGE HERE
  geom_boxplot(color = "black") +
  scale_fill_manual(values = c("lightgreen", "seagreen", "aquamarine2",  
                               "lightblue", "blue", "purple")) +
  labs(title = "Box Plot of Left Rostral Middle Frontal CT by Cluster",
       x = "Cluster group",
       y = "Left Rostral Middle Frontal CT") +
  theme_minimal()
p
# Add Tukey significance bars
p + geom_signif(comparisons = comparisons_sig,
                annotations = signif_labels,
                y_position = y_positions,
                tip_length = 0.01,
                vjust = 0.7) #increasing this value will make the stars closer to the bar 

###############################################################################################################################################

# -------------------------
# 1. ANOVA + TukeyHSD
# -------------------------
model1 <- aov(L_superiorparietal_thickavg ~ groups, data = compare_df2)
summary(model1)
car::Anova(model1)
eta_squared(model1)
TukeyHSD(model1)

tukey_res <- TukeyHSD(model1, "groups")$groups %>%
  as.data.frame() %>%
  rownames_to_column("contrast")

# -------------------------
# 2. Prepare comparisons
# -------------------------
# Split contrasts (e.g., "2-1") into list c("2","1")
comparisons <- strsplit(tukey_res$contrast, "-")

# Keep only significant comparisons
tukey_sig <- tukey_res %>% filter(`p adj` < 0.05)
comparisons_sig <- strsplit(tukey_sig$contrast, "-")

# Significance symbols
signif_labels <- ifelse(tukey_sig$`p adj` < 0.001, "***",
                   ifelse(tukey_sig$`p adj` < 0.01, "**",
                   ifelse(tukey_sig$`p adj` < 0.05, "*", "ns")))

# -------------------------
# 3. Assign y-positions
# -------------------------
y_max <- max(compare_df2$L_superiorparietal_thickavg, na.rm = TRUE) #### CHANGE HERE 
y_positions <- seq(y_max * 1.05,
                   by = y_max * 0.04, #increasing this will lead to great spaces betweem the bars 
                   length.out = length(comparisons_sig))

# -------------------------
# 4. Plot
# -------------------------
p <- ggplot(compare_df2, aes(x = groups, y = L_superiorparietal_thickavg, fill = groups)) + #CHANGE HERE
  geom_boxplot(color = "black") +
  scale_fill_manual(values = c("lightgreen", "seagreen", "aquamarine2",  
                               "lightblue", "blue", "purple")) +
  labs(title = "Box Plot of Left Superior Parietal CT by Cluster",
       x = "Cluster group",
       y = "Left Superior Parietal CT") +
  theme_minimal()
p
# Add Tukey significance bars
p + geom_signif(comparisons = comparisons_sig,
                annotations = signif_labels,
                y_position = y_positions,
                tip_length = 0.01,
                vjust = 0.7) #increasing this value will make the stars closer to the bar 

###############################################################################################################################################

# -------------------------
# 1. ANOVA + TukeyHSD
# -------------------------
model1 <- aov(R_superiorfrontal_thickavg ~ groups, data = compare_df2)
summary(model1)
car::Anova(model1)
TukeyHSD(model1)

tukey_res <- TukeyHSD(model1, "groups")$groups %>%
  as.data.frame() %>%
  rownames_to_column("contrast")

# -------------------------
# 2. Prepare comparisons
# -------------------------
# Split contrasts (e.g., "2-1") into list c("2","1")
comparisons <- strsplit(tukey_res$contrast, "-")

# Keep only significant comparisons
tukey_sig <- tukey_res %>% filter(`p adj` < 0.05)
comparisons_sig <- strsplit(tukey_sig$contrast, "-")

# Significance symbols
signif_labels <- ifelse(tukey_sig$`p adj` < 0.001, "***",
                   ifelse(tukey_sig$`p adj` < 0.01, "**",
                   ifelse(tukey_sig$`p adj` < 0.05, "*", "ns")))

# -------------------------
# 3. Assign y-positions
# -------------------------
y_max <- max(compare_df2$R_superiorfrontal_thickavg, na.rm = TRUE) #### CHANGE HERE 
y_positions <- seq(y_max * 1.05,
                   by = y_max * 0.02, #increasing this will lead to great spaces betweem the bars 
                   length.out = length(comparisons_sig))

# -------------------------
# 4. Plot
# -------------------------
p <- ggplot(compare_df2, aes(x = groups, y = R_superiorfrontal_thickavg, fill = groups)) + #CHANGE HERE
  geom_boxplot(color = "black") +
  scale_fill_manual(values = c("lightgreen", "seagreen", "aquamarine2",  
                               "lightblue", "blue", "purple")) +
  labs(title = "Box Plot of Right Superior Frontal CT by Cluster",
       x = "Cluster group",
       y = "Right Superior Frontal CT") +
  theme_minimal()

# Add Tukey significance bars
p + geom_signif(comparisons = comparisons_sig,
                annotations = signif_labels,
                y_position = y_positions,
                tip_length = 0.01,
                vjust = 0.7) #increasing this value will make the stars closer to the bar 
```

3. Subcortical Volume
```{r}
# -------------------------
# 1. ANOVA + TukeyHSD
# -------------------------
model1 <- aov(Lhippo_vol ~ groups, data = compare_df2)
summary(model1)
car::Anova(model1)
eta_squared(model1)
TukeyHSD(model1)

tukey_res <- TukeyHSD(model1, "groups")$groups %>%
  as.data.frame() %>%
  rownames_to_column("contrast")

# -------------------------
# 2. Prepare comparisons
# -------------------------
# Split contrasts (e.g., "2-1") into list c("2","1")
comparisons <- strsplit(tukey_res$contrast, "-")

# Keep only significant comparisons
tukey_sig <- tukey_res %>% filter(`p adj` < 0.05)
comparisons_sig <- strsplit(tukey_sig$contrast, "-")

# Significance symbols
signif_labels <- ifelse(tukey_sig$`p adj` < 0.001, "***",
                   ifelse(tukey_sig$`p adj` < 0.01, "**",
                   ifelse(tukey_sig$`p adj` < 0.05, "*", "ns")))

# -------------------------
# 3. Assign y-positions
# -------------------------
y_max <- max(compare_df2$Lhippo_vol, na.rm = TRUE) #### CHANGE HERE 
y_positions <- seq(y_max * 1.05,
                   by = y_max * 0.1, #increasing this will lead to great spaces betweem the bars 
                   length.out = length(comparisons_sig))

# -------------------------
# 4. Plot
# -------------------------
p <- ggplot(compare_df2, aes(x = groups, y = Lhippo_vol, fill = groups)) + #CHANGE HERE
  geom_boxplot(color = "black") +
  scale_fill_manual(values = c("lightgreen", "seagreen", "aquamarine2",  
                               "lightblue", "blue", "purple")) +
  labs(title = "Box Plot of Left Hippocampus Volume by Cluster",
       x = "Cluster group",
       y = "Left Hippocampus Volume") +
  theme_minimal()

# Add Tukey significance bars
p + geom_signif(comparisons = comparisons_sig,
                annotations = signif_labels,
                y_position = y_positions,
                tip_length = 0.01,
                vjust = 0.7) #increasing this value will make the stars closer to the bar 

###############################################################################################################################################

# -------------------------
# 1. ANOVA + TukeyHSD
# -------------------------
model1 <- aov(Lpal_vol ~ groups, data = compare_df2)
summary(model1)
car::Anova(model1)
eta_squared(model1)
TukeyHSD(model1)

tukey_res <- TukeyHSD(model1, "groups")$groups %>%
  as.data.frame() %>%
  rownames_to_column("contrast")

# -------------------------
# 2. Prepare comparisons
# -------------------------
# Split contrasts (e.g., "2-1") into list c("2","1")
comparisons <- strsplit(tukey_res$contrast, "-")

# Keep only significant comparisons
tukey_sig <- tukey_res %>% filter(`p adj` < 0.05)
comparisons_sig <- strsplit(tukey_sig$contrast, "-")

# Significance symbols
signif_labels <- ifelse(tukey_sig$`p adj` < 0.001, "***",
                   ifelse(tukey_sig$`p adj` < 0.01, "**",
                   ifelse(tukey_sig$`p adj` < 0.05, "*", "ns")))

# -------------------------
# 3. Assign y-positions
# -------------------------
y_max <- max(compare_df2$Lpal_vol, na.rm = TRUE) #### CHANGE HERE 
y_positions <- seq(y_max * 1.05,
                   by = y_max * 0.1, #increasing this will lead to great spaces betweem the bars 
                   length.out = length(comparisons_sig))

# -------------------------
# 4. Plot
# -------------------------
p <- ggplot(compare_df2, aes(x = groups, y = Lpal_vol, fill = groups)) + #CHANGE HERE
  geom_boxplot(color = "black") +
  scale_fill_manual(values = c("lightgreen", "seagreen", "aquamarine2",  
                               "lightblue", "blue", "purple")) +
  labs(title = "Box Plot of Left Pallidum Vol Volume by Cluster",
       x = "Cluster group",
       y = "Left Pallidum Vol Volume") +
  theme_minimal()

# Add Tukey significance bars
p + geom_signif(comparisons = comparisons_sig,
                annotations = signif_labels,
                y_position = y_positions,
                tip_length = 0.01,
                vjust = 0.7) #increasing this value will make the stars closer to the bar 

###############################################################################################################################################

# -------------------------
# 1. ANOVA + TukeyHSD
# -------------------------
model1 <- aov(Rhippo_vol ~ groups, data = compare_df2)
summary(model1)
car::Anova(model1)
TukeyHSD(model1)

tukey_res <- TukeyHSD(model1, "groups")$groups %>%
  as.data.frame() %>%
  rownames_to_column("contrast")

# -------------------------
# 2. Prepare comparisons
# -------------------------
# Split contrasts (e.g., "2-1") into list c("2","1")
comparisons <- strsplit(tukey_res$contrast, "-")

# Keep only significant comparisons
tukey_sig <- tukey_res %>% filter(`p adj` < 0.05)
comparisons_sig <- strsplit(tukey_sig$contrast, "-")

# Significance symbols
signif_labels <- ifelse(tukey_sig$`p adj` < 0.001, "***",
                   ifelse(tukey_sig$`p adj` < 0.01, "**",
                   ifelse(tukey_sig$`p adj` < 0.05, "*", "ns")))

# -------------------------
# 3. Assign y-positions
# -------------------------
y_max <- max(compare_df2$Rhippo_vol, na.rm = TRUE) #### CHANGE HERE 
y_positions <- seq(y_max * 1.05,
                   by = y_max * 0.1, #increasing this will lead to great spaces betweem the bars 
                   length.out = length(comparisons_sig))

# -------------------------
# 4. Plot
# -------------------------
p <- ggplot(compare_df2, aes(x = groups, y = Rhippo_vol, fill = groups)) + #CHANGE HERE
  geom_boxplot(color = "black") +
  scale_fill_manual(values = c("lightgreen", "seagreen", "aquamarine2",  
                               "lightblue", "blue", "purple")) +
  labs(title = "Box Plot of Right Hippocampus Volume by Cluster",
       x = "Cluster group",
       y = "Right Hippocampus Volume") +
  theme_minimal()

# Add Tukey significance bars
p + geom_signif(comparisons = comparisons_sig,
                annotations = signif_labels,
                y_position = y_positions,
                tip_length = 0.01,
                vjust = 0.7) #increasing this value will make the stars closer to the bar 
```

4. Cortical Surface Area 
```{r}
# -------------------------
# 1. ANOVA + TukeyHSD
# -------------------------
model1 <- aov(L_superiortemporal_surfavg ~ groups, data = compare_df2)
summary(model1)
car::Anova(model1)
eta_squared(model1)
TukeyHSD(model1)

tukey_res <- TukeyHSD(model1, "groups")$groups %>%
  as.data.frame() %>%
  rownames_to_column("contrast")

# -------------------------
# 2. Prepare comparisons
# -------------------------
# Split contrasts (e.g., "2-1") into list c("2","1")
comparisons <- strsplit(tukey_res$contrast, "-")

# Keep only significant comparisons
tukey_sig <- tukey_res %>% filter(`p adj` < 0.05)
comparisons_sig <- strsplit(tukey_sig$contrast, "-")

# Significance symbols
signif_labels <- ifelse(tukey_sig$`p adj` < 0.001, "***",
                   ifelse(tukey_sig$`p adj` < 0.01, "**",
                   ifelse(tukey_sig$`p adj` < 0.05, "*", "ns")))

# -------------------------
# 3. Assign y-positions
# -------------------------
y_max <- max(compare_df2$L_superiortemporal_surfavg, na.rm = TRUE) #### CHANGE HERE 
y_positions <- seq(y_max * 1.05,
                   by = y_max * 0.1, #increasing this will lead to great spaces betweem the bars 
                   length.out = length(comparisons_sig))

# -------------------------
# 4. Plot
# -------------------------
p <- ggplot(compare_df2, aes(x = groups, y = L_superiortemporal_surfavg, fill = groups)) + #CHANGE HERE
  geom_boxplot(color = "black") +
  scale_fill_manual(values = c("lightgreen", "seagreen", "aquamarine2",  
                               "lightblue", "blue", "purple")) +
  labs(title = "Box Plot of Left Superior Temporal SA by Cluster",
       x = "Cluster group",
       y = "Left Superior Temporal SA") +
  theme_minimal()

# Add Tukey significance bars
p + geom_signif(comparisons = comparisons_sig,
                annotations = signif_labels,
                y_position = y_positions,
                tip_length = 0.01,
                vjust = 0.7) #increasing this value will make the stars closer to the bar 

###############################################################################################################################################

# -------------------------
# 1. ANOVA + TukeyHSD
# -------------------------
model1 <- aov(R_middletemporal_surfavg ~ groups, data = compare_df2)
summary(model1)
car::Anova(model1)
eta_squared(model1)
TukeyHSD(model1)

tukey_res <- TukeyHSD(model1, "groups")$groups %>%
  as.data.frame() %>%
  rownames_to_column("contrast")

# -------------------------
# 2. Prepare comparisons
# -------------------------
# Split contrasts (e.g., "2-1") into list c("2","1")
comparisons <- strsplit(tukey_res$contrast, "-")

# Keep only significant comparisons
tukey_sig <- tukey_res %>% filter(`p adj` < 0.05)
comparisons_sig <- strsplit(tukey_sig$contrast, "-")

# Significance symbols
signif_labels <- ifelse(tukey_sig$`p adj` < 0.001, "***",
                   ifelse(tukey_sig$`p adj` < 0.01, "**",
                   ifelse(tukey_sig$`p adj` < 0.05, "*", "ns")))

# -------------------------
# 3. Assign y-positions
# -------------------------
y_max <- max(compare_df2$R_middletemporal_surfavg, na.rm = TRUE) #### CHANGE HERE 
y_positions <- seq(y_max * 1.05,
                   by = y_max * 0.1, #increasing this will lead to great spaces betweem the bars 
                   length.out = length(comparisons_sig))

# -------------------------
# 4. Plot
# -------------------------
p <- ggplot(compare_df2, aes(x = groups, y = R_middletemporal_surfavg, fill = groups)) + #CHANGE HERE
  geom_boxplot(color = "black") +
  scale_fill_manual(values = c("lightgreen", "seagreen", "aquamarine2",  
                               "lightblue", "blue", "purple")) +
  labs(title = "Box Plot of Right Middle Temporal SA by Cluster",
       x = "Cluster group",
       y = "Right Middle Temporal SA") +
  theme_minimal()
p
# Add Tukey significance bars
p + geom_signif(comparisons = comparisons_sig,
                annotations = signif_labels,
                y_position = y_positions,
                tip_length = 0.01,
                vjust = 0.7) #increasing this value will make the stars closer to the bar 

###############################################################################################################################################

# -------------------------
# 1. ANOVA + TukeyHSD
# -------------------------
model1 <- aov(L_precentral_surfavg ~ groups, data = compare_df2)
summary(model1)
car::Anova(model1)
TukeyHSD(model1)

tukey_res <- TukeyHSD(model1, "groups")$groups %>%
  as.data.frame() %>%
  rownames_to_column("contrast")

# -------------------------
# 2. Prepare comparisons
# -------------------------
# Split contrasts (e.g., "2-1") into list c("2","1")
comparisons <- strsplit(tukey_res$contrast, "-")

# Keep only significant comparisons
tukey_sig <- tukey_res %>% filter(`p adj` < 0.05)
comparisons_sig <- strsplit(tukey_sig$contrast, "-")

# Significance symbols
signif_labels <- ifelse(tukey_sig$`p adj` < 0.001, "***",
                   ifelse(tukey_sig$`p adj` < 0.01, "**",
                   ifelse(tukey_sig$`p adj` < 0.05, "*", "ns")))

# -------------------------
# 3. Assign y-positions
# -------------------------
y_max <- max(compare_df2$L_precentral_surfavg, na.rm = TRUE) #### CHANGE HERE 
y_positions <- seq(y_max * 1.05,
                   by = y_max * 0.1, #increasing this will lead to great spaces betweem the bars 
                   length.out = length(comparisons_sig))

# -------------------------
# 4. Plot
# -------------------------
p <- ggplot(compare_df2, aes(x = groups, y = L_precentral_surfavg, fill = groups)) + #CHANGE HERE
  geom_boxplot(color = "black") +
  scale_fill_manual(values = c("lightgreen", "seagreen", "aquamarine2",  
                               "lightblue", "blue", "purple")) +
  labs(title = "Box Plot of Left Precentral SA by Cluster",
       x = "Cluster group",
       y = "Left Precentral SA") +
  theme_minimal()
p
# Add Tukey significance bars
p + geom_signif(comparisons = comparisons_sig,
                annotations = signif_labels,
                y_position = y_positions,
                tip_length = 0.01,
                vjust = 0.7) #increasing this value will make the stars closer to the bar 
```

5. EA Task  
```{r}
# -------------------------
# 1. ANOVA + TukeyHSD
# -------------------------
model1 <- aov(X17Networks_LH_ContA_IPS_2 ~ groups, data = compare_df2)
summary(model1)
car::Anova(model1)
eta_squared(model1)
TukeyHSD(model1)

tukey_res <- TukeyHSD(model1, "groups")$groups %>%
  as.data.frame() %>%
  rownames_to_column("contrast")

# -------------------------
# 2. Prepare comparisons
# -------------------------
# Split contrasts (e.g., "2-1") into list c("2","1")
comparisons <- strsplit(tukey_res$contrast, "-")

# Keep only significant comparisons
tukey_sig <- tukey_res %>% filter(`p adj` < 0.05)
comparisons_sig <- strsplit(tukey_sig$contrast, "-")

# Significance symbols
signif_labels <- ifelse(tukey_sig$`p adj` < 0.001, "***",
                   ifelse(tukey_sig$`p adj` < 0.01, "**",
                   ifelse(tukey_sig$`p adj` < 0.05, "*", "ns")))

# -------------------------
# 3. Assign y-positions
# -------------------------
y_max <- max(compare_df2$X17Networks_LH_ContA_IPS_2, na.rm = TRUE) #### CHANGE HERE 
y_positions <- seq(y_max * 1.05,
                   by = y_max * 0.1, #increasing this will lead to great spaces betweem the bars 
                   length.out = length(comparisons_sig))

# -------------------------
# 4. Plot
# -------------------------
p <- ggplot(compare_df2, aes(x = groups, y = X17Networks_LH_ContA_IPS_2, fill = groups)) + #CHANGE HERE
  geom_boxplot(color = "black") +
  scale_fill_manual(values = c("lightgreen", "seagreen", "aquamarine2",  
                               "lightblue", "blue", "purple")) +
  labs(title = "Box Plot of Left Hemisphere ContA IPS 2 EA t-map by Cluster",
       x = "Cluster group",
       y = "Left Hemisphere ContA IPS 2 EA t-map") +
  theme_minimal()
p
# Add Tukey significance bars
p + geom_signif(comparisons = comparisons_sig,
                annotations = signif_labels,
                y_position = y_positions,
                tip_length = 0.01,
                vjust = 0.7) #increasing this value will make the stars closer to the bar 

###############################################################################################################################################

# -------------------------
# 1. ANOVA + TukeyHSD
# -------------------------
model1 <- aov(X17Networks_LH_SalVentAttnB_PFCl_1 ~ groups, data = compare_df2)
summary(model1)
car::Anova(model1)
eta_squared(model1)
TukeyHSD(model1)

tukey_res <- TukeyHSD(model1, "groups")$groups %>%
  as.data.frame() %>%
  rownames_to_column("contrast")

# -------------------------
# 2. Prepare comparisons
# -------------------------
# Split contrasts (e.g., "2-1") into list c("2","1")
comparisons <- strsplit(tukey_res$contrast, "-")

# Keep only significant comparisons
tukey_sig <- tukey_res %>% filter(`p adj` < 0.05)
comparisons_sig <- strsplit(tukey_sig$contrast, "-")

# Significance symbols
signif_labels <- ifelse(tukey_sig$`p adj` < 0.001, "***",
                   ifelse(tukey_sig$`p adj` < 0.01, "**",
                   ifelse(tukey_sig$`p adj` < 0.05, "*", "ns")))

# -------------------------
# 3. Assign y-positions
# -------------------------
y_max <- max(compare_df2$X17Networks_LH_SalVentAttnB_PFCl_1, na.rm = TRUE) #### CHANGE HERE 
y_positions <- seq(y_max * 1.05,
                   by = y_max * 0.1, #increasing this will lead to great spaces betweem the bars 
                   length.out = length(comparisons_sig))

# -------------------------
# 4. Plot
# -------------------------
p <- ggplot(compare_df2, aes(x = groups, y = X17Networks_LH_SalVentAttnB_PFCl_1, fill = groups)) + #CHANGE HERE
  geom_boxplot(color = "black") +
  scale_fill_manual(values = c("lightgreen", "seagreen", "aquamarine2",  
                               "lightblue", "blue", "purple")) +
  labs(title = "Box Plot of Left Hemisphere SalVentAttnB PFCl 1 EA t-map by Cluster",
       x = "Cluster group",
       y = "Left Hemisphere SalVentAttnB PFCl 1 EA t-map") +
  theme_minimal()
p
# Add Tukey significance bars
p + geom_signif(comparisons = comparisons_sig,
                annotations = signif_labels,
                y_position = y_positions,
                tip_length = 0.01,
                vjust = 0.7) #increasing this value will make the stars closer to the bar 

###############################################################################################################################################

# -------------------------
# 1. ANOVA + TukeyHSD
# -------------------------
model1 <- aov(aPUT.rh ~ groups, data = compare_df2)
summary(model1)
eta_squared(model1)
car::Anova(model1)
TukeyHSD(model1)

tukey_res <- TukeyHSD(model1, "groups")$groups %>%
  as.data.frame() %>%
  rownames_to_column("contrast")

# -------------------------
# 2. Prepare comparisons
# -------------------------
# Split contrasts (e.g., "2-1") into list c("2","1")
comparisons <- strsplit(tukey_res$contrast, "-")

# Keep only significant comparisons
tukey_sig <- tukey_res %>% filter(`p adj` < 0.05)
comparisons_sig <- strsplit(tukey_sig$contrast, "-")

# Significance symbols
signif_labels <- ifelse(tukey_sig$`p adj` < 0.001, "***",
                   ifelse(tukey_sig$`p adj` < 0.01, "**",
                   ifelse(tukey_sig$`p adj` < 0.05, "*", "ns")))

# -------------------------
# 3. Assign y-positions
# -------------------------
y_max <- max(compare_df2$aPUT.rh, na.rm = TRUE) #### CHANGE HERE 
y_positions <- seq(y_max * 1.05,
                   by = y_max * 0.1, #increasing this will lead to great spaces betweem the bars 
                   length.out = length(comparisons_sig))

# -------------------------
# 4. Plot
# -------------------------
p <- ggplot(compare_df2, aes(x = groups, y = aPUT.rh, fill = groups)) + #CHANGE HERE
  geom_boxplot(color = "black") +
  scale_fill_manual(values = c("lightgreen", "seagreen", "aquamarine2",  
                               "lightblue", "blue", "purple")) +
  labs(title = "Box Plot of Right Anterior Putamen EA t-map by Cluster",
       x = "Cluster group",
       y = "Right Anterior Putamen EA t-map") +
  theme_minimal()

# Add Tukey significance bars
p + geom_signif(comparisons = comparisons_sig,
                annotations = signif_labels,
                y_position = y_positions,
                tip_length = 0.01,
                vjust = 0.7) #increasing this value will make the stars closer to the bar 
```


########### Assessing Statistical Differences Across Held-out Features for Cluster Validation ################### 

1. Mentalizing 
2. Social Functioning (BSFS Total Score)
3. Neurocognition 
4. Resting State Network Differences 
5. Fractional Anisotropy (FA)
6. Mean Diffusivity (MD)
7. Additional: Medication (CPZ Equivalents), Age, IQ, BPRS Total (Symptom Severity), Motion (mean FD) during EA task and Resting state 

1. Mentalizing 
```{r}
#Now again for Mentalizing (Factor score for higher-level social cogntion)
# -------------------------
# 1. ANOVA + TukeyHSD
# -------------------------
model1 <- aov(mentalizing ~ groups, data = compare_df2)
summary(model1)
car::Anova(model1)
eta_squared(model1, partial = TRUE)

TukeyHSD(model1)

tukey_res <- TukeyHSD(model1, "groups")$groups %>%
  as.data.frame() %>%
  rownames_to_column("contrast")

# -------------------------
# 2. Prepare comparisons
# -------------------------
# Split contrasts (e.g., "2-1") into list c("2","1")
comparisons <- strsplit(tukey_res$contrast, "-")

# Keep only significant comparisons
tukey_sig <- tukey_res %>% filter(`p adj` < 0.05)
comparisons_sig <- strsplit(tukey_sig$contrast, "-")

# Significance symbols
signif_labels <- ifelse(tukey_sig$`p adj` < 0.001, "***",
                   ifelse(tukey_sig$`p adj` < 0.01, "**",
                   ifelse(tukey_sig$`p adj` < 0.05, "*", "ns")))

# -------------------------
# 3. Assign y-positions
# -------------------------
y_max <- max(compare_df2$mentalizing, na.rm = TRUE)
y_positions <- seq(y_max * 1.05,
                   by = y_max * 0.15, #increasing this will lead to great spaces betweem the bars 
                   length.out = length(comparisons_sig))

# -------------------------
# 4. Plot
# -------------------------
p <- ggplot(compare_df2, aes(x = groups, y = mentalizing, fill = groups)) +
  geom_boxplot(color = "black") +
  scale_fill_manual(values = c("lightgreen", "seagreen", "aquamarine2",  
                               "lightblue", "blue", "purple")) +
  labs(title = "Box Plot of Mentalizing Score by Cluster",
       x = "Cluster group",
       y = "Mentalizing Score") +
  theme_minimal()

# Add Tukey significance bars
p + geom_signif(comparisons = comparisons_sig,
                annotations = signif_labels,
                y_position = y_positions,
                tip_length = 0.01,
                vjust = 0.7) #increasing this value will make the stars closer to the bar
```

2. BSFS Total Score 
```{r}
#Now again for BSFS - held-out vairable
# -------------------------
# 1. ANOVA + TukeyHSD
# -------------------------
model1 <- aov(bsfs_total ~ groups, data = compare_df2)
summary(model1)
car::Anova(model1)
eta_squared(model1, partial = TRUE)

TukeyHSD(model1)

tukey_res <- TukeyHSD(model1, "groups")$groups %>%
  as.data.frame() %>%
  rownames_to_column("contrast")

# -------------------------
# 2. Prepare comparisons
# -------------------------
# Split contrasts (e.g., "2-1") into list c("2","1")
comparisons <- strsplit(tukey_res$contrast, "-")

# Keep only significant comparisons
tukey_sig <- tukey_res %>% filter(`p adj` < 0.05)
comparisons_sig <- strsplit(tukey_sig$contrast, "-")

# Significance symbols
signif_labels <- ifelse(tukey_sig$`p adj` < 0.001, "***",
                   ifelse(tukey_sig$`p adj` < 0.01, "**",
                   ifelse(tukey_sig$`p adj` < 0.05, "*", "ns")))

# -------------------------
# 3. Assign y-positions
# -------------------------
y_max <- max(compare_df2$bsfs_total, na.rm = TRUE)
y_positions <- seq(y_max * 1.05,
                   by = y_max * 0.035, #increasing this will lead to great spaces betweem the bars 
                   length.out = length(comparisons_sig))

# -------------------------
# 4. Plot
# -------------------------
p <- ggplot(compare_df2, aes(x = groups, y = bsfs_total, fill = groups)) +
  geom_boxplot(color = "black") +
  scale_fill_manual(values = c("lightgreen", "seagreen", "aquamarine2",  
                               "lightblue", "blue", "purple")) +
  labs(title = "Box Plot of BSFS Total Score by Cluster",
       x = "Cluster group",
       y = "BSFS Total Score") +
  theme_minimal()

# Add Tukey significance bars
p + geom_signif(comparisons = comparisons_sig,
                annotations = signif_labels,
                y_position = y_positions,
                tip_length = 0.01,
                vjust = 0.7) #increasing this value will make the stars closer to the bar
```

3. Neurocogntion 
```{r}
# -------------------------
# 1. ANOVA + TukeyHSD
# -------------------------
model1 <- aov(mccb_comp ~ groups, data = compare_df2)
summary(model1)
car::Anova(model1)
eta_squared(model1)

TukeyHSD(model1)

tukey_res <- TukeyHSD(model1, "groups")$groups %>%
  as.data.frame() %>%
  rownames_to_column("contrast")

# -------------------------
# 2. Prepare comparisons
# -------------------------
# Split contrasts (e.g., "2-1") into list c("2","1")
comparisons <- strsplit(tukey_res$contrast, "-")

# Keep only significant comparisons
tukey_sig <- tukey_res %>% filter(`p adj` < 0.05)
comparisons_sig <- strsplit(tukey_sig$contrast, "-")

# Significance symbols
signif_labels <- ifelse(tukey_sig$`p adj` < 0.001, "***",
                   ifelse(tukey_sig$`p adj` < 0.01, "**",
                   ifelse(tukey_sig$`p adj` < 0.05, "*", "ns")))

# -------------------------
# 3. Assign y-positions
# -------------------------
y_max <- max(compare_df2$mccb_comp, na.rm = TRUE) #### CHANGE HERE 
y_positions <- seq(y_max * 1.05,
                   by = y_max * 0.04, #increasing this will lead to great spaces betweem the bars 
                   length.out = length(comparisons_sig))

# -------------------------
# 4. Plot
# -------------------------
p <- ggplot(compare_df2, aes(x = groups, y = mccb_comp, fill = groups)) + #CHANGE HERE
  geom_boxplot(color = "black") +
  scale_fill_manual(values = c("lightgreen", "seagreen", "aquamarine2",  
                               "lightblue", "blue", "purple")) +
  labs(title = "Box Plot of MCCB Composite Score by Cluster",
       x = "Cluster group",
       y = "MCCB Composite Score") +
  theme_minimal()
p
# Add Tukey significance bars
p + geom_signif(comparisons = comparisons_sig,
                annotations = signif_labels,
                y_position = y_positions,
                tip_length = 0.01,
                vjust = 0.7) #increasing this value will make the stars closer to the bar 

###############################################################################################################################################

# -------------------------
# 1. ANOVA + TukeyHSD
# -------------------------
model1 <- aov(mccb_vislearn ~ groups, data = compare_df2)
summary(model1)
car::Anova(model1)
eta_squared(model1)

TukeyHSD(model1)

tukey_res <- TukeyHSD(model1, "groups")$groups %>%
  as.data.frame() %>%
  rownames_to_column("contrast")

# -------------------------
# 2. Prepare comparisons
# -------------------------
# Split contrasts (e.g., "2-1") into list c("2","1")
comparisons <- strsplit(tukey_res$contrast, "-")

# Keep only significant comparisons
tukey_sig <- tukey_res %>% filter(`p adj` < 0.05)
comparisons_sig <- strsplit(tukey_sig$contrast, "-")

# Significance symbols
signif_labels <- ifelse(tukey_sig$`p adj` < 0.001, "***",
                   ifelse(tukey_sig$`p adj` < 0.01, "**",
                   ifelse(tukey_sig$`p adj` < 0.05, "*", "ns")))

# -------------------------
# 3. Assign y-positions
# -------------------------
y_max <- max(compare_df2$mccb_vislearn, na.rm = TRUE) #### CHANGE HERE 
y_positions <- seq(y_max * 1.05,
                   by = y_max * 0.04, #increasing this will lead to great spaces betweem the bars 
                   length.out = length(comparisons_sig))

# -------------------------
# 4. Plot
# -------------------------
p <- ggplot(compare_df2, aes(x = groups, y = mccb_vislearn, fill = groups)) + #CHANGE HERE
  geom_boxplot(color = "black") +
  scale_fill_manual(values = c("lightgreen", "seagreen", "aquamarine2",  
                               "lightblue", "blue", "purple")) +
  labs(title = "Box Plot of MCCB Visual Learning Score by Cluster",
       x = "Cluster group",
       y = "MCCB Visual Learning Score") +
  theme_minimal()
p
# Add Tukey significance bars
p + geom_signif(comparisons = comparisons_sig,
                annotations = signif_labels,
                y_position = y_positions,
                tip_length = 0.01,
                vjust = 0.7) #increasing this value will make the stars closer to the bar 

###############################################################################################################################################

# -------------------------
# 1. ANOVA + TukeyHSD
# -------------------------
model1 <- aov(mccb_pspeed ~ groups, data = compare_df2)
summary(model1)
car::Anova(model1)
eta_squared(model1)

TukeyHSD(model1)

tukey_res <- TukeyHSD(model1, "groups")$groups %>%
  as.data.frame() %>%
  rownames_to_column("contrast")

# -------------------------
# 2. Prepare comparisons
# -------------------------
# Split contrasts (e.g., "2-1") into list c("2","1")
comparisons <- strsplit(tukey_res$contrast, "-")

# Keep only significant comparisons
tukey_sig <- tukey_res %>% filter(`p adj` < 0.05)
comparisons_sig <- strsplit(tukey_sig$contrast, "-")

# Significance symbols
signif_labels <- ifelse(tukey_sig$`p adj` < 0.001, "***",
                   ifelse(tukey_sig$`p adj` < 0.01, "**",
                   ifelse(tukey_sig$`p adj` < 0.05, "*", "ns")))

# -------------------------
# 3. Assign y-positions
# -------------------------
y_max <- max(compare_df2$mccb_pspeed, na.rm = TRUE) #### CHANGE HERE 
y_positions <- seq(y_max * 1.05,
                   by = y_max * 0.04, #increasing this will lead to great spaces betweem the bars 
                   length.out = length(comparisons_sig))

# -------------------------
# 4. Plot
# -------------------------
p <- ggplot(compare_df2, aes(x = groups, y = mccb_pspeed, fill = groups)) + #CHANGE HERE
  geom_boxplot(color = "black") +
  scale_fill_manual(values = c("lightgreen", "seagreen", "aquamarine2",  
                               "lightblue", "blue", "purple")) +
  labs(title = "Box Plot of MCCB Processing Speed by Cluster",
       x = "Cluster group",
       y = " MCCB Processing Speed") +
  theme_minimal()
p
# Add Tukey significance bars
p + geom_signif(comparisons = comparisons_sig,
                annotations = signif_labels,
                y_position = y_positions,
                tip_length = 0.01,
                vjust = 0.7) #increasing this value will make the stars closer to the bar 
```

4. RS network differences
```{r}

compare_df3 <- read.csv("/projects/tsecara/metaSNF/SNF/full_sample_no_FA_MD/final_output/full_RESULTS_5_clust_k48_0.6.csv")
compare_df3$groups <- as.factor(compare_df3$groups)
RS_anal <- read.csv("/projects/tsecara/metaSNF/data/combat_data/combat_data3/RS_noGSR.csv")
RS_anal <- RS_anal[,-1]
compare_df3 <- inner_join(compare_df3, RS_anal, by = "participant_id")


# -------------------------
# 1. ANOVA + TukeyHSD
# -------------------------
model1 <- aov(RowMean_SOM_visual ~ groups, data = compare_df3)
summary(model1)
car::Anova(model1)
eta_squared(model1)
TukeyHSD(model1)

tukey_res <- TukeyHSD(model1, "groups")$groups %>%
  as.data.frame() %>%
  rownames_to_column("contrast")

# -------------------------
# 2. Prepare comparisons
# -------------------------
# Split contrasts (e.g., "2-1") into list c("2","1")
comparisons <- strsplit(tukey_res$contrast, "-")

# Keep only significant comparisons
tukey_sig <- tukey_res %>% filter(`p adj` < 0.05)
comparisons_sig <- strsplit(tukey_sig$contrast, "-")

# Significance symbols
signif_labels <- ifelse(tukey_sig$`p adj` < 0.001, "***",
                   ifelse(tukey_sig$`p adj` < 0.01, "**",
                   ifelse(tukey_sig$`p adj` < 0.05, "*", "ns")))

# -------------------------
# 3. Assign y-positions
# -------------------------
y_max <- max(compare_df3$RowMean_SOM_visual, na.rm = TRUE) #### CHANGE HERE 
y_positions <- seq(y_max * 1.05,
                   by = y_max * 0.03, #increasing this will lead to great spaces betweem the bars 
                   length.out = length(comparisons_sig))

# -------------------------
# 4. Plot
# -------------------------
p <- ggplot(compare_df3, aes(x = groups, y = RowMean_SOM_visual, fill = groups)) + #CHANGE HERE
  geom_boxplot(color = "black") +
  scale_fill_manual(values = c("lightgreen", "seagreen", "aquamarine2",  
                               "lightblue", "blue", "purple")) +
  labs(title = "Box Plot of SOM to Visual Network (RS) by Cluster",
       x = "Cluster group",
       y = "SOM to Visual Network Connectivity") +
  theme_minimal()

# Add Tukey significance bars
p + geom_signif(comparisons = comparisons_sig,
                annotations = signif_labels,
                y_position = y_positions,
                tip_length = 0.01,
                vjust = 0.7) #increasing this value will make the stars closer to the bar 

###############################################################################################################################################

# -------------------------
# 1. ANOVA + TukeyHSD
# -------------------------
model1 <- aov(RowMean_DMN_visual ~ groups, data = compare_df3)
summary(model1)
car::Anova(model1)
eta_squared(model1)
TukeyHSD(model1)

tukey_res <- TukeyHSD(model1, "groups")$groups %>%
  as.data.frame() %>%
  rownames_to_column("contrast")

# -------------------------
# 2. Prepare comparisons
# -------------------------
# Split contrasts (e.g., "2-1") into list c("2","1")
comparisons <- strsplit(tukey_res$contrast, "-")

# Keep only significant comparisons
tukey_sig <- tukey_res %>% filter(`p adj` < 0.05)
comparisons_sig <- strsplit(tukey_sig$contrast, "-")

# Significance symbols
signif_labels <- ifelse(tukey_sig$`p adj` < 0.001, "***",
                   ifelse(tukey_sig$`p adj` < 0.01, "**",
                   ifelse(tukey_sig$`p adj` < 0.05, "*", "ns")))

# -------------------------
# 3. Assign y-positions
# -------------------------
y_max <- max(compare_df3$RowMean_DMN_visual, na.rm = TRUE) #### CHANGE HERE 
y_positions <- seq(y_max * 1.05,
                   by = y_max * 0.1, #increasing this will lead to great spaces betweem the bars 
                   length.out = length(comparisons_sig))

# -------------------------
# 4. Plot
# -------------------------
p <- ggplot(compare_df3, aes(x = groups, y = RowMean_DMN_visual, fill = groups)) + #CHANGE HERE
  geom_boxplot(color = "black") +
  scale_fill_manual(values = c("lightgreen", "seagreen", "aquamarine2",  
                               "lightblue", "blue", "purple")) +
  labs(title = "Box Plot of DMN to Visual Network Connectivity (RS) by Cluster",
       x = "Cluster group",
       y = " DMN to Visual Network Connectivity") +
  theme_minimal()

# Add Tukey significance bars
p + geom_signif(comparisons = comparisons_sig,
                annotations = signif_labels,
                y_position = y_positions,
                tip_length = 0.01,
                vjust = 0.7) #increasing this value will make the stars closer to the bar 

###############################################################################################################################################

# -------------------------
# 1. ANOVA + TukeyHSD
# -------------------------
model1 <- aov(RowMean_SUB_visual ~ groups, data = compare_df3)
summary(model1)
car::Anova(model1)
TukeyHSD(model1)

tukey_res <- TukeyHSD(model1, "groups")$groups %>%
  as.data.frame() %>%
  rownames_to_column("contrast")

# -------------------------
# 2. Prepare comparisons
# -------------------------
# Split contrasts (e.g., "2-1") into list c("2","1")
comparisons <- strsplit(tukey_res$contrast, "-")

# Keep only significant comparisons
tukey_sig <- tukey_res %>% filter(`p adj` < 0.05)
comparisons_sig <- strsplit(tukey_sig$contrast, "-")

# Significance symbols
signif_labels <- ifelse(tukey_sig$`p adj` < 0.001, "***",
                   ifelse(tukey_sig$`p adj` < 0.01, "**",
                   ifelse(tukey_sig$`p adj` < 0.05, "*", "ns")))

# -------------------------
# 3. Assign y-positions
# -------------------------
y_max <- max(compare_df3$RowMean_SUB_visual, na.rm = TRUE) #### CHANGE HERE 
y_positions <- seq(y_max * 1.05,
                   by = y_max * 0.1, #increasing this will lead to great spaces betweem the bars 
                   length.out = length(comparisons_sig))

# -------------------------
# 4. Plot
# -------------------------
p <- ggplot(compare_df3, aes(x = groups, y = RowMean_SUB_visual, fill = groups)) + #CHANGE HERE
  geom_boxplot(color = "black") +
  scale_fill_manual(values = c("lightgreen", "seagreen", "aquamarine2",  
                               "lightblue", "blue", "purple")) +
  labs(title = "Box Plot of SUB to Visual Network (RS) by Cluster",
       x = "Cluster group",
       y = "SUB to Visual Network Connectivity") +
  theme_minimal()

# Add Tukey significance bars
p + geom_signif(comparisons = comparisons_sig,
                annotations = signif_labels,
                y_position = y_positions,
                tip_length = 0.01,
                vjust = 0.7) #increasing this value will make the stars closer to the bar 
```


5. FA Comparisons 
```{r}
# -------------------------
# 1. ANOVA + TukeyHSD
# -------------------------
model1 <- aov(FX_FA ~ groups, data = compare_df2)
summary(model1)
car::Anova(model1)
eta_squared(model1)
TukeyHSD(model1)

tukey_res <- TukeyHSD(model1, "groups")$groups %>%
  as.data.frame() %>%
  rownames_to_column("contrast")

# -------------------------
# 2. Prepare comparisons
# -------------------------
# Split contrasts (e.g., "2-1") into list c("2","1")
comparisons <- strsplit(tukey_res$contrast, "-")

# Keep only significant comparisons
tukey_sig <- tukey_res %>% filter(`p adj` < 0.05)
comparisons_sig <- strsplit(tukey_sig$contrast, "-")

# Significance symbols
signif_labels <- ifelse(tukey_sig$`p adj` < 0.001, "***",
                   ifelse(tukey_sig$`p adj` < 0.01, "**",
                   ifelse(tukey_sig$`p adj` < 0.05, "*", "ns")))

# -------------------------
# 3. Assign y-positions
# -------------------------
y_max <- max(compare_df2$FX_FA, na.rm = TRUE) #### CHANGE HERE 
y_positions <- seq(y_max * 1.05,
                   by = y_max * 0.08, #increasing this will lead to great spaces betweem the bars 
                   length.out = length(comparisons_sig))

# -------------------------
# 4. Plot
# -------------------------
p <- ggplot(compare_df2, aes(x = groups, y = FX_FA, fill = groups)) + #CHANGE HERE
  geom_boxplot(color = "black") +
  scale_fill_manual(values = c("lightgreen", "seagreen", "aquamarine2",  
                               "lightblue", "blue", "purple")) +
  labs(title = "Box Plot of Fornix FA by Cluster",
       x = "Cluster group",
       y = "Fornix FA") +
  theme_minimal()

# Add Tukey significance bars
p + geom_signif(comparisons = comparisons_sig,
                annotations = signif_labels,
                y_position = y_positions,
                tip_length = 0.01,
                vjust = 0.7) #increasing this value will make the stars closer to the bar 

###############################################################################################################################################

# -------------------------
# 1. ANOVA + TukeyHSD
# -------------------------
model1 <- aov(PLIC.R_FA ~ groups, data = compare_df2)
summary(model1)
car::Anova(model1)
eta_squared(model1)
TukeyHSD(model1)

tukey_res <- TukeyHSD(model1, "groups")$groups %>%
  as.data.frame() %>%
  rownames_to_column("contrast")

# -------------------------
# 2. Prepare comparisons
# -------------------------
# Split contrasts (e.g., "2-1") into list c("2","1")
comparisons <- strsplit(tukey_res$contrast, "-")

# Keep only significant comparisons
tukey_sig <- tukey_res %>% filter(`p adj` < 0.05)
comparisons_sig <- strsplit(tukey_sig$contrast, "-")

# Significance symbols
signif_labels <- ifelse(tukey_sig$`p adj` < 0.001, "***",
                   ifelse(tukey_sig$`p adj` < 0.01, "**",
                   ifelse(tukey_sig$`p adj` < 0.05, "*", "ns")))

# -------------------------
# 3. Assign y-positions
# -------------------------
y_max <- max(compare_df2$PLIC.R_FA, na.rm = TRUE) #### CHANGE HERE 
y_positions <- seq(y_max * 1.05,
                   by = y_max * 0.03, #increasing this will lead to great spaces betweem the bars 
                   length.out = length(comparisons_sig))

# -------------------------
# 4. Plot
# -------------------------
p <- ggplot(compare_df2, aes(x = groups, y = PLIC.R_FA, fill = groups)) + #CHANGE HERE
  geom_boxplot(color = "black") +
  scale_fill_manual(values = c("lightgreen", "seagreen", "aquamarine2",  
                               "lightblue", "blue", "purple")) +
  labs(title = "Box Plot of Left PLIC FA by Cluster",
       x = "Cluster group",
       y = "Left PTR FA") +
  theme_minimal()

# Add Tukey significance bars
p + geom_signif(comparisons = comparisons_sig,
                annotations = signif_labels,
                y_position = y_positions,
                tip_length = 0.01,
                vjust = 0.7) #increasing this value will make the stars closer to the bar 

###############################################################################################################################################

# -------------------------
# 1. ANOVA + TukeyHSD
# -------------------------
model1 <- aov(CP.R_FA ~ groups, data = compare_df2)
summary(model1)
car::Anova(model1)
TukeyHSD(model1)

tukey_res <- TukeyHSD(model1, "groups")$groups %>%
  as.data.frame() %>%
  rownames_to_column("contrast")

# -------------------------
# 2. Prepare comparisons
# -------------------------
# Split contrasts (e.g., "2-1") into list c("2","1")
comparisons <- strsplit(tukey_res$contrast, "-")

# Keep only significant comparisons
tukey_sig <- tukey_res %>% filter(`p adj` < 0.05)
comparisons_sig <- strsplit(tukey_sig$contrast, "-")

# Significance symbols
signif_labels <- ifelse(tukey_sig$`p adj` < 0.001, "***",
                   ifelse(tukey_sig$`p adj` < 0.01, "**",
                   ifelse(tukey_sig$`p adj` < 0.05, "*", "ns")))

# -------------------------
# 3. Assign y-positions
# -------------------------
y_max <- max(compare_df2$CP.R_FA, na.rm = TRUE) #### CHANGE HERE 
y_positions <- seq(y_max * 1.05,
                   by = y_max * 0.03, #increasing this will lead to great spaces betweem the bars 
                   length.out = length(comparisons_sig))

# -------------------------
# 4. Plot
# -------------------------
p <- ggplot(compare_df2, aes(x = groups, y = CP.R_FA, fill = groups)) + #CHANGE HERE
  geom_boxplot(color = "black") +
  scale_fill_manual(values = c("lightgreen", "seagreen", "aquamarine2",  
                               "lightblue", "blue", "purple")) +
  labs(title = "Box Plot of Right SS FA by Cluster",
       x = "Cluster group",
       y = "Right SS FA") +
  theme_minimal()

# Add Tukey significance bars
p + geom_signif(comparisons = comparisons_sig,
                annotations = signif_labels,
                y_position = y_positions,
                tip_length = 0.01,
                vjust = 0.7) #increasing this value will make the stars closer to the bar 
```

6. MD
```{r}
# -------------------------
# 1. ANOVA + TukeyHSD
# -------------------------
model1 <- aov(UNC.L_MD ~ groups, data = compare_df2)
summary(model1)
car::Anova(model1)
eta_squared(model1)
TukeyHSD(model1)

tukey_res <- TukeyHSD(model1, "groups")$groups %>%
  as.data.frame() %>%
  rownames_to_column("contrast")

# -------------------------
# 2. Prepare comparisons
# -------------------------
# Split contrasts (e.g., "2-1") into list c("2","1")
comparisons <- strsplit(tukey_res$contrast, "-")

# Keep only significant comparisons
tukey_sig <- tukey_res %>% filter(`p adj` < 0.05)
comparisons_sig <- strsplit(tukey_sig$contrast, "-")

# Significance symbols
signif_labels <- ifelse(tukey_sig$`p adj` < 0.001, "***",
                   ifelse(tukey_sig$`p adj` < 0.01, "**",
                   ifelse(tukey_sig$`p adj` < 0.05, "*", "ns")))

# -------------------------
# 3. Assign y-positions
# -------------------------
y_max <- max(compare_df2$UNC.L_MD, na.rm = TRUE) #### CHANGE HERE 
y_positions <- seq(y_max * 1.05,
                   by = y_max * 0.02, #increasing this will lead to great spaces betweem the bars 
                   length.out = length(comparisons_sig))

# -------------------------
# 4. Plot
# -------------------------
p <- ggplot(compare_df2, aes(x = groups, y = UNC.L_MD, fill = groups)) + #CHANGE HERE
  geom_boxplot(color = "black") +
  scale_fill_manual(values = c("lightgreen", "seagreen", "aquamarine2",  
                               "lightblue", "blue", "purple")) +
  labs(title = "Box Plot of Left UNC MD by Cluster",
       x = "Cluster group",
       y = "Left UNC MD") +
  theme_minimal()

# Add Tukey significance bars
p + geom_signif(comparisons = comparisons_sig,
                annotations = signif_labels,
                y_position = y_positions,
                tip_length = 0.01,
                vjust = 0.7) #increasing this value will make the stars closer to the bar 

###############################################################################################################################################

# -------------------------
# 1. ANOVA + TukeyHSD
# -------------------------
model1 <- aov(RLIC.L_MD ~ groups, data = compare_df2)
summary(model1)
car::Anova(model1)
TukeyHSD(model1)

tukey_res <- TukeyHSD(model1, "groups")$groups %>%
  as.data.frame() %>%
  rownames_to_column("contrast")

# -------------------------
# 2. Prepare comparisons
# -------------------------
# Split contrasts (e.g., "2-1") into list c("2","1")
comparisons <- strsplit(tukey_res$contrast, "-")

# Keep only significant comparisons
tukey_sig <- tukey_res %>% filter(`p adj` < 0.05)
comparisons_sig <- strsplit(tukey_sig$contrast, "-")

# Significance symbols
signif_labels <- ifelse(tukey_sig$`p adj` < 0.001, "***",
                   ifelse(tukey_sig$`p adj` < 0.01, "**",
                   ifelse(tukey_sig$`p adj` < 0.05, "*", "ns")))

# -------------------------
# 3. Assign y-positions
# -------------------------
y_max <- max(compare_df2$RLIC.L_MD, na.rm = TRUE) #### CHANGE HERE 
y_positions <- seq(y_max * 1.05,
                   by = y_max * 0.02, #increasing this will lead to great spaces betweem the bars 
                   length.out = length(comparisons_sig))

# -------------------------
# 4. Plot
# -------------------------
p <- ggplot(compare_df2, aes(x = groups, y = RLIC.L_MD, fill = groups)) + #CHANGE HERE
  geom_boxplot(color = "black") +
  scale_fill_manual(values = c("lightgreen", "seagreen", "aquamarine2",  
                               "lightblue", "blue", "purple")) +
  labs(title = "Box Plot of Left RLIC MD by Cluster",
       x = "Cluster group",
       y = "Left RLIC MD") +
  theme_minimal()

# Add Tukey significance bars
p + geom_signif(comparisons = comparisons_sig,
                annotations = signif_labels,
                y_position = y_positions,
                tip_length = 0.01,
                vjust = 0.7) #increasing this value will make the stars closer to the bar 

```

Medication (CPZ Equivalents)
```{r}
###Looking at the effect of medication 
cpz <- read.csv(".../medication/spasd_spins_cpze_final.csv")
compare_df_cpz <- merge(cpz[, c("participant_id", "cpz_eq_final")], compare_df2, by = "participant_id")

model1 <- aov(cpz_eq_final ~ groups, data = compare_df_cpz)
summary(model1)
car::Anova(model1)
etasq(model1)

TukeyHSD(model1)

# Create a box plot with different colors for each group
p <- ggplot(compare_df_cpz, aes(x = groups, y = cpz_eq_final, fill = groups)) +
  geom_boxplot(color = "black") +
  scale_fill_manual(values = c("lightgreen", "seagreen", "aquamarine2",  "lightblue", "blue", "purple" )) +
  labs(title = "Box Plot of CPZ eqv by Cluster",
       x = "Cluster group",
       y = "CPZ Equivalent") +
  theme_minimal()
p
```

Age
```{r}
#Now assessing Age differences 
model1 <- aov(age ~ groups, data = compare_df2)
summary(model1)
car::Anova(model1)
eta_squared(model1)

TukeyHSD(model1)

# Create a box plot with different colors for each group
p <- ggplot(compare_df2, aes(x = groups, y = age, fill = groups)) +
  geom_boxplot(color = "black") +
  scale_fill_manual(values = c("lightgreen", "seagreen", "aquamarine2",  "lightblue", "blue", "purple")) +
  labs(title = "Box Plot of Age by Cluster",
       x = "Cluster group",
       y = "Age") +
  theme_minimal()
p
# Assuming you have three groups: Group1, Group2, and Group3
your_comparisons <- list(c("5", "1"), c("5", "3"))
y_positions <- c(36, 38)
# Add significance indicators to the boxplot
p +
  geom_signif(comparisons = your_comparisons[1], map_signif_level = TRUE, vjust = 0.6, y_position = y_positions[1]) +
  geom_signif(comparisons = your_comparisons[2], map_signif_level = TRUE, vjust = 0.6, y_position = y_positions[2])
```

IQ 
```{r}
#Assessing IQ differences 
# -------------------------
# 1. ANOVA + TukeyHSD
# -------------------------
model1 <- aov(iq ~ groups, data = compare_df2)
summary(model1)
car::Anova(model1)
eta_squared(model1, partial = TRUE)

TukeyHSD(model1)

tukey_res <- TukeyHSD(model1, "groups")$groups %>%
  as.data.frame() %>%
  rownames_to_column("contrast")

# -------------------------
# 2. Prepare comparisons
# -------------------------
# Split contrasts (e.g., "2-1") into list c("2","1")
comparisons <- strsplit(tukey_res$contrast, "-")

# Keep only significant comparisons
tukey_sig <- tukey_res %>% filter(`p adj` < 0.05)
comparisons_sig <- strsplit(tukey_sig$contrast, "-")

# Significance symbols
signif_labels <- ifelse(tukey_sig$`p adj` < 0.001, "***",
                   ifelse(tukey_sig$`p adj` < 0.01, "**",
                   ifelse(tukey_sig$`p adj` < 0.05, "*", "ns")))

# -------------------------
# 3. Assign y-positions
# -------------------------
y_max <- max(compare_df2$iq, na.rm = TRUE)
y_positions <- seq(y_max * 1.05,
                   by = y_max * 0.025, #increasing this will lead to great spaces betweem the bars 
                   length.out = length(comparisons_sig))

# -------------------------
# 4. Plot
# -------------------------
p <- ggplot(compare_df2, aes(x = groups, y = iq, fill = groups)) +
  geom_boxplot(color = "black") +
  scale_fill_manual(values = c("lightgreen", "seagreen", "aquamarine2",  
                               "lightblue", "blue", "purple")) +
  labs(title = "Box Plot of IQ by Cluster",
       x = "Cluster group",
       y = "IQ") +
  theme_minimal()

# Add Tukey significance bars
p + geom_signif(comparisons = comparisons_sig,
                annotations = signif_labels,
                y_position = y_positions,
                tip_length = 0.01,
                vjust = 0.7) #increasing this value will make the stars closer to the bar

```

BPRS Total Score (Symptom Severity)
```{r}
#Now assessing Age differences 
model1 <- aov(bprs_total ~ groups, data = compare_df2)
summary(model1)
car::Anova(model1)
eta_squared(model1)

TukeyHSD(model1)


# Create a box plot with different colors for each group
p <- ggplot(compare_df2, aes(x = groups, y = bprs_total, fill = groups)) +
  geom_boxplot(color = "black") +
  scale_fill_manual(values = c("lightgreen", "seagreen", "aquamarine2",  "lightblue", "blue", "purple")) +
  labs(title = "Box Plot of Symptom Severity by Cluster",
       x = "Cluster group",
       y = "BPRS Total Score") +
  theme_minimal()
p
```

Looking at Motion (mean FD) during EA task
```{r}
###Looking at the effect of medication 
ea <- read.csv("/projects/tsecara/SPINS_ASD_Project2/data/combined/motion/EA_task_motion_FINAL_metaSNF.csv")
compare_df_ea <- merge(ea[, c("participant_id", "avg_fd")], compare_df2, by = "participant_id")

#Now assessing Age differences 
model1 <- aov(avg_fd ~ groups, data = compare_df_ea)
summary(model1)
car::Anova(model1)
eta_squared(model1)

TukeyHSD(model1)


# Create a box plot with different colors for each group
p <- ggplot(compare_df_ea, aes(x = groups, y = avg_fd, fill = groups)) +
  geom_boxplot(color = "black") +
  scale_fill_manual(values = c("lightgreen", "seagreen", "aquamarine2",  "lightblue", "blue", "purple")) +
  labs(title = "Box Plot of EA Motion by Cluster",
       x = "Cluster group",
       y = "Mean FD") +
  theme_minimal()
p
# Assuming you have three groups: Group1, Group2, and Group3
your_comparisons <- list(c("5", "1"))
y_positions <- c(0.4)
# Add significance indicators to the boxplot
p +
  geom_signif(comparisons = your_comparisons[1], map_signif_level = TRUE, vjust = 0.6, y_position = y_positions[1]) 

```

Looking at Motion (mean FD) during Resting State
```{r}
###Looking at the effect of medication 
ea <- read.csv("/projects/tsecara/SPINS_ASD_Project2/data/combined/motion/RS_motion_FINAL.csv")
compare_df_ea <- merge(ea[, c("participant_id", "avg_fd")], compare_df2, by = "participant_id")

#Now assessing Age differences 
model1 <- aov(avg_fd ~ groups, data = compare_df_ea)
summary(model1)
car::Anova(model1)
etasq(model1)

TukeyHSD(model1)


# Create a box plot with different colors for each group
p <- ggplot(compare_df_ea, aes(x = groups, y = avg_fd, fill = groups)) +
  geom_boxplot(color = "black") +
  scale_fill_manual(values = c("lightgreen", "seagreen", "aquamarine2",  "lightblue", "blue", "purple")) +
  labs(title = "Box Plot of Resting State Motion by Cluster",
       x = "Cluster group",
       y = "Mean FD") +
  theme_minimal()
p
# Assuming you have three groups: Group1, Group2, and Group3
#your_comparisons <- list(c("4", "1"))
#y_positions <- c(0.45)
# Add significance indicators to the boxplot
#p +
 # geom_signif(comparisons = your_comparisons[1], map_signif_level = TRUE, vjust = 0.6, y_position = y_positions[1]) 

```

################################ STATISTICAL TABLES #################################################################
Neurocog 
```{r}
# ===============================
# One-way ANOVAs for all MCCB vars (+ eta^2)
# ===============================
library(dplyr)
library(purrr)
library(broom)
library(effectsize)
library(tibble)

# Ensure groups is a factor
compare_df2 <- compare_df2 %>% mutate(groups = as.factor(groups))

# Identify MCCB outcome columns
mccb_cols <- names(compare_df2)[grepl("^mccb_", names(compare_df2))]

# Helper to pull eta^2 across effectsize versions; falls back to manual eta^2 if needed
.get_eta2 <- function(mod, var){
  es_try <- try(effectsize::eta_squared(mod, ci = 0.95, partial = FALSE), silent = TRUE)
  if (!inherits(es_try, "try-error")) {
    es_tbl <- as_tibble(es_try)
    eta_col  <- intersect(c("Eta2","eta.sq"), names(es_tbl))[1]
    low_col  <- intersect(c("CI_low","CI.low"), names(es_tbl))[1]
    high_col <- intersect(c("CI_high","CI.high"), names(es_tbl))[1]
    if (!is.na(eta_col)) {
      return(tibble(
        outcome = var,
        eta2 = es_tbl[[eta_col]][1],
        eta2_ci_low  = if (!is.na(low_col))  es_tbl[[low_col]][1]  else NA_real_,
        eta2_ci_high = if (!is.na(high_col)) es_tbl[[high_col]][1] else NA_real_
      ))
    }
  }
  # Fallback: manual eta^2 from ANOVA table (no CI)
  aov_tab   <- stats::anova(mod)
  ss_groups <- as.numeric(aov_tab[rownames(aov_tab) == "groups", "Sum Sq"])
  ss_resid  <- as.numeric(aov_tab[rownames(aov_tab) == "Residuals", "Sum Sq"])
  eta2_man  <- ss_groups / (ss_groups + ss_resid)
  tibble(outcome = var, eta2 = eta2_man, eta2_ci_low = NA_real_, eta2_ci_high = NA_real_)
}

# Run ANOVA for each MCCB variable and combine
mccb_anova_summary <- map_dfr(mccb_cols, function(var) {
  # Fit ANOVA
  model <- aov(reformulate("groups", response = var), data = compare_df2)

  # F and p for the groups term
  omni <- broom::tidy(model) %>%
    filter(term == "groups") %>%
    transmute(outcome = var,
              F_value = statistic,
              p_value = p.value)

  # eta^2 (+/- CI when available)
  es <- .get_eta2(model, var)

  left_join(omni, es, by = "outcome")
}) %>%
  mutate(p_fdr = p.adjust(p_value, method = "fdr")) %>%
  arrange(p_fdr)

write.csv(mccb_anova_summary, "/projects/tsecara/metaSNF/SNF/full_sample_no_FA_MD/final_output/statistics/neurocog.csv")
# Peek
# head(mccb_anova_summary)

```

Social Cog 
```{r}
# ===============================
# Social cognition ANOVAs (F, p, p_FDR, eta^2)
# ===============================
library(dplyr)
library(purrr)
library(broom)
library(effectsize)
library(tibble)

# Ensure groups is a factor
compare_df2 <- compare_df2 %>% mutate(groups = as.factor(groups))

# Your specified social-cog outcomes
cog_tests <- c("rmet_total",
               "er40_total",
               "tasit1_total",
               "tasit2_sin",
               "tasit2_ssar",
               "tasit2_psar",
               "tasit3_lies",
               "tasit3_sar")

# Keep only those present in the dataframe
soc_cols <- intersect(cog_tests, names(compare_df2))
if (length(soc_cols) == 0) stop("None of the specified social-cog columns were found in compare_df2.")

# Helper to pull eta^2 across effectsize versions; falls back to manual eta^2 if needed
.get_eta2 <- function(mod, var){
  es_try <- try(effectsize::eta_squared(mod, ci = 0.95, partial = FALSE), silent = TRUE)
  if (!inherits(es_try, "try-error")) {
    es_tbl <- as_tibble(es_try)
    eta_col  <- intersect(c("Eta2","eta.sq"), names(es_tbl))[1]
    low_col  <- intersect(c("CI_low","CI.low"), names(es_tbl))[1]
    high_col <- intersect(c("CI_high","CI.high"), names(es_tbl))[1]
    if (!is.na(eta_col)) {
      return(tibble(
        outcome = var,
        eta2 = es_tbl[[eta_col]][1],
        eta2_ci_low  = if (!is.na(low_col))  es_tbl[[low_col]][1]  else NA_real_,
        eta2_ci_high = if (!is.na(high_col)) es_tbl[[high_col]][1] else NA_real_
      ))
    }
  }
  # Fallback: manual eta^2 (no CI)
  aov_tab   <- stats::anova(mod)
  ss_groups <- as.numeric(aov_tab[rownames(aov_tab) == "groups", "Sum Sq"])
  ss_resid  <- as.numeric(aov_tab[rownames(aov_tab) == "Residuals", "Sum Sq"])
  eta2_man  <- ss_groups / (ss_groups + ss_resid)
  tibble(outcome = var, eta2 = eta2_man, eta2_ci_low = NA_real_, eta2_ci_high = NA_real_)
}

# Run ANOVA for each social-cog variable
socialcog_anova_summary <- map_dfr(soc_cols, function(var) {
  df_var <- compare_df2 %>% select(groups, !!sym(var)) %>% filter(!is.na(.data[[var]]))

  # If fewer than 2 groups with data, return NA row
  if (df_var %>% distinct(groups) %>% nrow() < 2) {
    return(tibble(
      outcome = var, F_value = NA_real_, p_value = NA_real_,
      eta2 = NA_real_, eta2_ci_low = NA_real_, eta2_ci_high = NA_real_
    ))
  }

  model <- aov(reformulate("groups", response = var), data = df_var)

  omni <- broom::tidy(model) %>%
    filter(term == "groups") %>%
    transmute(outcome = var, F_value = statistic, p_value = p.value)

  es <- .get_eta2(model, var)

  left_join(omni, es, by = "outcome")
}) %>%
  mutate(p_fdr = p.adjust(p_value, method = "fdr")) %>%
  arrange(p_fdr)

write.csv(socialcog_anova_summary, "/projects/tsecara/metaSNF/SNF/full_sample_no_FA_MD/final_output/statistics/social_cog.csv")

# Peek
# socialcog_anova_summary

```
